[
  {
    "pg_get_functiondef": "CREATE OR REPLACE FUNCTION public._log_job_candidate_stage_transition()\n RETURNS trigger\n LANGUAGE plpgsql\n SET search_path TO ''\nAS $function$\nDECLARE\n    prev_stage candidate_stage; -- Changed from TEXT to candidate_stage enum\n    BEGIN\n        -- Get previous stage from shadow table\n            IF tg_op = 'INSERT' THEN\n                    prev_stage := null;\n                        ELSE\n                                prev_stage := (\n                                            SELECT last_stage::candidate_stage -- Explicit cast to enum\n                                                        FROM public._job_candidate_stage_shadow \n                                                                    WHERE job_candidate_id = new.id\n                                                                            );\n                                                                                END IF;\n\n                                                                                    -- Log transition if stage actually changed\n                                                                                        IF prev_stage IS DISTINCT FROM new.stage THEN\n                                                                                                INSERT INTO public.job_pipeline_stage_events(\n                                                                                                            org_id, \n                                                                                                                        job_id, \n                                                                                                                                    candidate_id, \n                                                                                                                                                job_candidate_id,\n                                                                                                                                                            from_stage, \n                                                                                                                                                                        to_stage, \n                                                                                                                                                                                    changed_at, \n                                                                                                                                                                                                changed_by\n                                                                                                                                                                                                        )\n                                                                                                                                                                                                                VALUES (\n                                                                                                                                                                                                                            new.org_id,\n                                                                                                                                                                                                                                        new.job_id,\n                                                                                                                                                                                                                                                    new.candidate_id,\n                                                                                                                                                                                                                                                                new.id,\n                                                                                                                                                                                                                                                                            prev_stage,\n                                                                                                                                                                                                                                                                                        new.stage,\n                                                                                                                                                                                                                                                                                                    new.updated_at,\n                                                                                                                                                                                                                                                                                                                auth.uid()\n                                                                                                                                                                                                                                                                                                                        );\n\n                                                                                                                                                                                                                                                                                                                                -- Update shadow table\n                                                                                                                                                                                                                                                                                                                                        INSERT INTO public._job_candidate_stage_shadow(job_candidate_id, last_stage, updated_at)\n                                                                                                                                                                                                                                                                                                                                                VALUES (new.id, new.stage, new.updated_at)\n                                                                                                                                                                                                                                                                                                                                                        ON CONFLICT (job_candidate_id) DO UPDATE\n                                                                                                                                                                                                                                                                                                                                                                SET last_stage = excluded.last_stage, updated_at = excluded.updated_at;\n                                                                                                                                                                                                                                                                                                                                                                    END IF;\n\n                                                                                                                                                                                                                                                                                                                                                                        RETURN new;\n                                                                                                                                                                                                                                                                                                                                                                        END\n                                                                                                                                                                                                                                                                                                                                                                        $function$\n"
  }
]